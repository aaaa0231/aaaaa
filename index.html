<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P Chat</title>
<style>
body{font-family:sans-serif;background:#0f1221;color:#e8ebff;margin:0;padding:0;}
.container{max-width:600px;margin:20px auto;padding:10px;}
textarea,input,button{width:100%;margin-top:5px;padding:8px;border-radius:6px;border:none;background:#1c2040;color:#e8ebff;}
button{cursor:pointer;background:#6c8cff;color:#fff;}
#messages{border:1px solid #333;height:300px;overflow-y:auto;padding:5px;margin-top:10px;}
.msg{margin:5px 0;padding:6px;border-radius:6px;background:#1c2040;}
.msg.self{background:#2a356b;text-align:right;}
</style>
</head>
<body>
<div class="container">
  <h2>P2P Chat (コピペ方式)</h2>

  <label>自分の名前</label>
  <input type="text" id="username" placeholder="名前">

  <button id="createOffer">オファー作成</button>
  <textarea id="offerOutput" placeholder="ここにオファーが生成されます" rows="4"></textarea>

  <label>相手のオファー/アンサーを貼り付け</label>
  <textarea id="inputSDP" placeholder="ここにオファーまたはアンサーを貼り付け"></textarea>
  <button id="setRemote">貼り付けを送信</button>

  <div id="messages"></div>

  <input type="text" id="messageInput" placeholder="メッセージ">
  <button id="sendBtn">送信</button>
</div>

<script>
let localConnection = new RTCPeerConnection();
let dataChannel = null;
let username = '';
const messagesEl = document.getElementById('messages');
const offerOutput = document.getElementById('offerOutput');
const inputSDP = document.getElementById('inputSDP');

document.getElementById('username').addEventListener('input', e=>{
  username = e.target.value.trim() || '匿名';
});

function addMessage(msg,isSelf=false){
  const div = document.createElement('div');
  div.className='msg'+(isSelf?' self':'');
  div.textContent=msg;
  messagesEl.appendChild(div);
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

// オファー作成
document.getElementById('createOffer').onclick=async ()=>{
  dataChannel = localConnection.createDataChannel('chat');
  dataChannel.onmessage=e=>addMessage(e.data,false);

  localConnection.onicecandidate = e=>{
    if(e.candidate===null){
      offerOutput.value = JSON.stringify(localConnection.localDescription);
    }
  }

  const offer = await localConnection.createOffer();
  await localConnection.setLocalDescription(offer);
};

// リモートSDP設定
document.getElementById('setRemote').onclick=async ()=>{
  const sdp = JSON.parse(inputSDP.value.trim());
  if(sdp.type==='offer'){
    localConnection.ondatachannel = e=>{
      dataChannel = e.channel;
      dataChannel.onmessage = e=>addMessage(e.data,false);
    };
    await localConnection.setRemoteDescription(sdp);
    const answer = await localConnection.createAnswer();
    await localConnection.setLocalDescription(answer);
    offerOutput.value = JSON.stringify(localConnection.localDescription);
  } else if(sdp.type==='answer'){
    await localConnection.setRemoteDescription(sdp);
  }
  inputSDP.value='';
};

// メッセージ送信
document.getElementById('sendBtn').onclick=()=>{
  const msg = document.getElementById('messageInput').value.trim();
  if(msg && dataChannel && dataChannel.readyState==='open'){
    dataChannel.send(username+': '+msg);
    addMessage(username+': '+msg,true);
    document.getElementById('messageInput').value='';
  }
};
</script>
</body>
</html>
