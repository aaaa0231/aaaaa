<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è¿‘ä»£UIã‚µãƒ¼ãƒãƒ¼ç„¡ã—P2Pãƒãƒ£ãƒƒãƒˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:sans-serif;background:#eaeaea;margin:0;padding:0;}
#roomDiv,#chat{max-width:600px;margin:20px auto;background:#fff;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
#messages{height:300px;overflow-y:auto;margin-bottom:10px;}
.msg-card{border-radius:10px;padding:8px 12px;margin:5px 0;display:inline-block;max-width:80%;}
.msg-card.you{background:#d1ffd1;color:#006600;align-self:flex-end;}
.msg-card.other{background:#d1e0ff;color:#003366;align-self:flex-start;}
.msg-card.system{background:#f0f0f0;color:#666;font-style:italic;align-self:center;}
#users{margin:10px 0;font-weight:bold;display:flex;flex-wrap:wrap;gap:5px;}
.user-icon{background:#ddd;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:14px;}
.roomItem{cursor:pointer;background:#007bff;color:white;padding:5px 10px;border-radius:8px;margin:3px 0;display:block;text-align:center;}
input,button,textarea{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:1px solid #ccc;}
#progressContainer{margin:5px 0;}
</style>
</head>
<body>

<div id="roomDiv">
<h2>ãƒ«ãƒ¼ãƒ ä½œæˆ / ãƒ«ãƒ¼ãƒ ä¸€è¦§</h2>
<input id="roomName" placeholder="ãƒ«ãƒ¼ãƒ å">
<input id="roomPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createRoom">ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
<h3>ãƒ«ãƒ¼ãƒ ä¸€è¦§</h3>
<div id="roomList" style="max-height:200px;overflow-y:auto;"></div>
</div>

<div id="chat" style="display:none">
<h2>ğŸŒ P2Pãƒãƒ£ãƒƒãƒˆ</h2>
<div id="users"></div>
<div id="messages" style="display:flex;flex-direction:column;"></div>
<input id="name" placeholder="åå‰ã‚’å…¥åŠ›">
<input id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
<button id="send">é€ä¿¡</button>
<button id="voice">éŸ³å£°ON/OFF</button>
<input type="file" id="fileInput">
<div id="progressContainer" style="display:none;">
  <progress id="fileProgress" value="0" max="100"></progress>
  <span id="fileProgressLabel"></span>
</div>
<hr>
<h3>æ¥ç¶š</h3>
<textarea id="signal" placeholder="æ¥ç¶šãƒ‡ãƒ¼ã‚¿"></textarea>
<button id="copy">æ¥ç¶šãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼</button>
<button id="connect">æ¥ç¶š</button>
</div>

<script>
// ==== è¨­å®š ====
const GIST_ID = prompt("Gist IDã‚’å…¥åŠ›");
const TOKEN = prompt("GitHub Personal Access Tokenã‚’å…¥åŠ›");
const FETCH_INTERVAL = 1500;
let rooms=[], localName="", pcList={}, channelList={}, localStream=null;
let connectedUsers = [], originalTitle=document.title;

// ==== ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º ====
function addUser(name){if(!connectedUsers.includes(name)){connectedUsers.push(name); renderUsers();}}
function removeUser(name){connectedUsers = connectedUsers.filter(n=>n!==name); renderUsers();}
function renderUsers(){
  const div=document.getElementById("users"); div.innerHTML="";
  connectedUsers.forEach(u=>{
    const icon=document.createElement("div"); icon.className="user-icon"; icon.textContent=u[0].toUpperCase(); div.appendChild(icon);
  });
}

// ==== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º ====
function log(msg,who="system"){
  const container=document.createElement("div");
  const card=document.createElement("div"); card.textContent=msg; card.className="msg-card "+who;
  container.appendChild(card);
  document.getElementById("messages").appendChild(container);
  document.getElementById("messages").scrollTop=9999;
  if(who==="other") flashTitle();
}

// ==== ã‚¿ãƒ–é€šçŸ¥ ====
function flashTitle(){
  let count=0;
  const interval=setInterval(()=>{
    document.title=(count%2===0?"ğŸ’¬ æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼":originalTitle);
    count++; if(count>3) clearInterval(interval);
  },500);
}

// ==== ãƒ«ãƒ¼ãƒ åŒæœŸ ====
async function fetchRooms(){
  try{
    const res=await fetch(`https://gist.githubusercontent.com/${GIST_ID}/raw/rooms.json`);
    rooms=await res.json(); renderRoomList();
  }catch(e){console.error("ãƒ«ãƒ¼ãƒ å–å¾—å¤±æ•—",e);}
}
function renderRoomList(){
  const roomListDiv=document.getElementById("roomList"); roomListDiv.innerHTML="";
  rooms.forEach(r=>{
    const btn=document.createElement("div"); btn.textContent=r.name+(r.password?" ğŸ”’":""); btn.className="roomItem";
    btn.onclick=()=>joinRoom(r); roomListDiv.appendChild(btn);
  });
}

// ==== ãƒ«ãƒ¼ãƒ ä½œæˆãƒ»æ›´æ–° ====
async function updateGist(rooms){
  const res=await fetch(`https://api.github.com/gists/${GIST_ID}`,{
    method:"PATCH",
    headers:{"Authorization":"token "+TOKEN,"Content-Type":"application/json"},
    body:JSON.stringify({files:{"rooms.json":{content:JSON.stringify(rooms,null,2)}}})
  });
  if(!res.ok) alert("Gistæ›´æ–°å¤±æ•—");
}
document.getElementById("createRoom").onclick=async()=>{
  const name=document.getElementById("roomName").value.trim();
  const pass=document.getElementById("roomPass").value.trim();
  if(!name) return alert("ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›");
  if(rooms.find(r=>r.name===name)) return alert("åŒåãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã™");
  rooms.push({name,password:pass});
  await updateGist(rooms); fetchRooms();
}

// ==== ãƒ«ãƒ¼ãƒ å‚åŠ  ====
function joinRoom(room){
  if(room.password){const input=prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›"); if(input!==room.password) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„ã¾ã™");}
  document.getElementById("roomDiv").style.display="none"; document.getElementById("chat").style.display="block";
  log("ã‚·ã‚¹ãƒ†ãƒ : "+room.name+" ã«å…¥å®¤","system");
}

// ==== P2Pãƒ»ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ====
const messages=document.getElementById("messages");
let servers={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};
function createPeer(id,offer=false){
  const pc=new RTCPeerConnection(servers);
  if(localStream) pc.addTrack(localStream.getTracks()[0],localStream);
  if(offer){const ch=pc.createDataChannel("chat"); channelList[id]=ch; setupChannel(ch);}
  else{pc.ondatachannel=e=>{const ch=e.channel; channelList[id]=ch; setupChannel(ch);}}
  pc.onicecandidate=e=>{if(e.candidate) return; document.getElementById("signal").value=JSON.stringify(pc.localDescription);}
  pc.ontrack=e=>{const audio=document.createElement("audio"); audio.srcObject=e.streams[0]; audio.autoplay=true; audio.playsInline=true; document.body.appendChild(audio);}
  pc.onconnectionstatechange=e=>{if(pc.connectionState==="disconnected"||pc.connectionState==="failed") removeUser(id);}
  pcList[id]=pc; return pc;
}
function setupChannel(ch){ch.onmessage=e=>{const data=JSON.parse(e.data);
if(data.type==="text") log(`${data.name}: ${data.text}`,"other");
else if(data.type==="fileChunk"){
  if(!window.fileBuffer) window.fileBuffer={};
  if(!window.fileBuffer[data.filename]) window.fileBuffer[data.filename]=[];
  window.fileBuffer[data.filename].push(data.chunk);
  const receivedSize=window.fileBuffer[data.filename].reduce((acc,c)=>acc+c.length,0);
  const progress=(receivedSize/data.total)*100;
  document.getElementById("progressContainer").style.display="block";
  document.getElementById("fileProgress").value=progress;
  document.getElementById("fileProgressLabel").textContent=`${Math.round(progress)}%`;
  if(receivedSize>=data.total){
    const blob=new Blob(window.fileBuffer[data.filename],{type:data.blobType});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=data.filename; a.textContent="ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"; log(`${data.name}ãŒãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡å®Œäº†: ${data.filename}`,"system");
    messages.appendChild(a); delete window.fileBuffer[data.filename]; document.getElementById("progressContainer").style.display="none";
  }
}}}

// P2Pæ¥ç¶šãƒœã‚¿ãƒ³
async function makeOffer(){const id="peer_"+Math.random().toString(36).substr(2,5); const pc=createPeer(id,true); addUser(id); const offer=await pc.createOffer(); await pc.setLocalDescription(offer); document.getElementById("signal").value=JSON.stringify(offer); log("ã‚ªãƒ•ã‚¡ãƒ¼ã‚³ãƒ”ãƒ¼ã—ã¦é€ä¿¡");}
async function connectToPeer(){const data=document.getElementById("signal").value.trim(); if(!data) return; const desc=JSON.parse(data); const id="peer_"+Math.random().toString(36).substr(2,5); const pc=createPeer(id,desc.type==="offer"?false:true); addUser(id); await pc.setRemoteDescription(desc); if(desc.type==="offer"){const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);}}
document.getElementById("copy").onclick=makeOffer; document.getElementById("connect").onclick=connectToPeer;

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
document.getElementById("send").onclick=()=>{
  const text=document.getElementById("text").value.trim(); localName=document.getElementById("name").value.trim()||"åŒ¿å";
  if(!text) return; log(`${localName}: ${text}`,"you");
  for(const id in channelList) channelList[id].send(JSON.stringify({type:"text",name:localName,text}));
  document.getElementById("text").value="";
};

// éŸ³å£°ON/OFF
let voiceEnabled=false;
document.getElementById("voice").onclick=async()=>{
  if(!voiceEnabled){localStream=await navigator.mediaDevices.getUserMedia({audio:true}); voiceEnabled=true; document.getElementById("voice").textContent="éŸ³å£°OFF"; log("ğŸ¤ éŸ³å£°ON","system");}
  else{localStream.getTracks().forEach(t=>t.stop()); localStream=null; voiceEnabled=false; document.getElementById("voice").textContent="éŸ³å£°ON"; log("ğŸ¤ éŸ³å£°OFF","system");}
};

// ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡é«˜é€ŸåŒ–
document.getElementById("fileInput").onchange=e=>{
  const file=e.target.files[0]; if(!file) return; const chunkSize=64*1024; let offset=0; const reader=new FileReader();
  document.getElementById("progressContainer").style.display="block";
  reader.onload=()=>{
    const chunk=new Uint8Array(reader.result);
    for(const id in channelList) channelList[id].send(JSON.stringify({type:"fileChunk",name:localName,chunk,filename:file.name,blobType:file.type,total:file.size}));
    offset+=chunkSize;
    document.getElementById("fileProgress").value=(offset/file.size)*100;
    document.getElementById("fileProgressLabel").textContent=`${Math.min(100,Math.round((offset/file.size)*100))}%`;
    if(offset<file.size) readSlice(); else setTimeout(()=>{document.getElementById("progressContainer").style.display="none";},500);
  }
  function readSlice(){reader.readAsArrayBuffer(file.slice(offset,offset+chunkSize));}
  readSlice();
};

// åˆå› fetch + ãƒãƒ¼ãƒªãƒ³ã‚°
fetchRooms(); setInterval(fetchRooms,FETCH_INTERVAL);
</script>
</body>
</html>
