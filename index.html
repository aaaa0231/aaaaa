<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>P2Pãƒãƒ£ãƒƒãƒˆï¼ˆGitHub Pageså¯¾å¿œï¼‰</title>
<style>
body{font-family:"Segoe UI",sans-serif;background:#eef1f5;margin:0;padding:20px;}
#app{max-width:600px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,0.1);}
#log{height:300px;overflow-y:auto;border:1px solid #ccc;padding:10px;margin-bottom:10px;border-radius:8px;background:#fafafa;}
.msg{margin:6px 0;padding:8px 12px;border-radius:8px;max-width:80%;word-wrap:break-word;}
.me{background:#d4f9d2;margin-left:auto;}
.other{background:#f0f0f0;}
.system{text-align:center;color:#666;font-size:0.9em;}
input,textarea,button{width:100%;padding:10px;margin:5px 0;box-sizing:border-box;border-radius:6px;border:1px solid #ccc;font-size:1em;}
button{background:#007bff;color:#fff;border:none;cursor:pointer;transition:0.3s;}
button:hover{background:#0056b3;}
.flex{display:flex;gap:5px;}
</style>
</head>
<body>
<div id="app">
  <h2>ğŸŒ ã‚µãƒ¼ãƒãƒ¼ãªã—P2Pãƒãƒ£ãƒƒãƒˆ</h2>
  <div id="log"></div>

  <div class="flex">
    <input id="name" placeholder="ã‚ãªãŸã®åå‰">
  </div>
  <div class="flex">
    <input id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <button id="send">é€ä¿¡</button>
  </div>

  <h3>æ¥ç¶šæ“ä½œ</h3>
  <button id="makeOffer">â‘  ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ä½œæˆï¼ˆæœ€åˆã®äººï¼‰</button>
  <button id="makeAnswer">â‘¡ ã‚¢ãƒ³ã‚µãƒ¼ã‚’ä½œæˆï¼ˆå‚åŠ ã™ã‚‹äººï¼‰</button>

  <textarea id="signal" placeholder="ã“ã“ã«ã‚ªãƒ•ã‚¡ãƒ¼ï¼ã‚¢ãƒ³ã‚µãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ or ã‚³ãƒ”ãƒ¼"></textarea>
  <div class="flex">
    <button id="copy">ã‚³ãƒ”ãƒ¼</button>
    <button id="connect">æ¥ç¶š</button>
  </div>
</div>

<script>
let pc, channel;
const servers = {iceServers:[{urls:"stun:stun.l.google.com:19302"}]};
const logDiv = document.getElementById("log");

function addLog(text, cls="system"){
  const div=document.createElement("div");
  div.textContent=text;
  div.className="msg "+cls;
  logDiv.appendChild(div);
  logDiv.scrollTop=logDiv.scrollHeight;
}

// é€ä¿¡å‡¦ç†
document.getElementById("send").onclick=()=>{
  if(!channel || channel.readyState!=="open") return;
  const name=document.getElementById("name").value.trim()||"åŒ¿å";
  const text=document.getElementById("msg").value.trim();
  if(!text) return;
  const data={name,text};
  channel.send(JSON.stringify(data));
  addLog(`${name}: ${text}`,"me");
  document.getElementById("msg").value="";
};

// ã‚ªãƒ•ã‚¡ãƒ¼ä½œæˆ
document.getElementById("makeOffer").onclick=async()=>{
  pc=new RTCPeerConnection(servers);
  channel=pc.createDataChannel("chat");
  setupChannel(channel);
  pc.onicecandidate=e=>{
    if(!e.candidate){
      document.getElementById("signal").value=JSON.stringify(pc.localDescription);
    }
  };
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  addLog("ğŸ“¤ ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã«é€ã£ã¦ãã ã•ã„ã€‚");
};

// ã‚¢ãƒ³ã‚µãƒ¼ä½œæˆ
document.getElementById("makeAnswer").onclick=()=>{
  pc=new RTCPeerConnection(servers);
  pc.ondatachannel=e=>{
    channel=e.channel;
    setupChannel(channel);
  };
  pc.onicecandidate=e=>{
    if(!e.candidate){
      document.getElementById("signal").value=JSON.stringify(pc.localDescription);
    }
  };
  addLog("ğŸ“¥ ã‚ªãƒ•ã‚¡ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œæ¥ç¶šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
};

// æ¥ç¶š
document.getElementById("connect").onclick=async()=>{
  const txt=document.getElementById("signal").value.trim();
  if(!txt) return alert("æ¥ç¶šãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  const desc=JSON.parse(txt);
  await pc.setRemoteDescription(desc);
  if(desc.type==="offer"){
    const answer=await pc.createAnswer();
    await pc.setLocalDescription(answer);
  }
  addLog("â³ æ¥ç¶šä¸­...");
};

// ã‚³ãƒ”ãƒ¼
document.getElementById("copy").onclick=()=>{
  navigator.clipboard.writeText(document.getElementById("signal").value);
  alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
};

// ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®š
function setupChannel(ch){
  channel=ch;
  channel.onopen=()=>addLog("âœ… æ¥ç¶šæˆåŠŸï¼ãƒãƒ£ãƒƒãƒˆé–‹å§‹ã§ãã¾ã™ã€‚");
  channel.onmessage=e=>{
    const data=JSON.parse(e.data);
    addLog(`${data.name}: ${data.text}`,"other");
  };
}
</script>
</body>
</html>
