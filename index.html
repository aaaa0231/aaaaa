<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å®Œå…¨P2Pãƒãƒ«ãƒãƒãƒ£ãƒƒãƒˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:sans-serif;background:#f0f0f0;margin:0;text-align:center}
#chat{max-width:600px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px #ccc}
#messages{height:300px;overflow-y:auto;border:1px solid #ccc;padding:5px;text-align:left;margin-bottom:10px}
.msg{margin:5px 0}
input,button,textarea{width:100%;padding:8px;margin:5px 0}
</style>
</head>
<body>
<div id="chat">
<h2>ğŸŒ GitHub P2På®Œå…¨ãƒãƒ«ãƒãƒãƒ£ãƒƒãƒˆ</h2>
<div id="messages"></div>
<input id="name" placeholder="åå‰ã‚’å…¥åŠ›">
<input id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
<button id="send">é€ä¿¡</button>
<button id="voice">éŸ³å£°ON/OFF</button>
<input type="file" id="fileInput">
<hr>
<h3>ãƒ«ãƒ¼ãƒ æ¥ç¶š</h3>
<textarea id="signal" placeholder="æ¥ç¶šãƒ‡ãƒ¼ã‚¿è‡ªå‹•åŒæœŸ"></textarea>
<button id="copy">æ¥ç¶šãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼</button>
<button id="connect">æ¥ç¶š</button>
</div>

<script>
const params=new URLSearchParams(window.location.search);
const room=params.get("room")||"default";
const messages=document.getElementById("messages");
let localName="", pcList={}, channelList={}, localStream=null;

function log(msg,who="system"){
  const div=document.createElement("div");
  div.textContent=msg;
  div.className="msg "+who;
  messages.appendChild(div);
  messages.scrollTop=9999;
  if(who==="you"||who==="other"){
    let history=JSON.parse(localStorage.getItem("chat_"+room)||"[]");
    history.push(msg);
    localStorage.setItem("chat_"+room,JSON.stringify(history));
  }
}
let history=JSON.parse(localStorage.getItem("chat_"+room)||"[]");
history.forEach(msg=>log(msg,"history"));

const servers={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

function createPeer(id,offer=false){
  const pc=new RTCPeerConnection(servers);

  if(localStream) pc.addTrack(localStream.getTracks()[0],localStream);

  if(offer){
    const ch=pc.createDataChannel("chat");
    channelList[id]=ch;
    setupChannel(ch);
  }else{
    pc.ondatachannel=e=>{
      const ch=e.channel;
      channelList[id]=ch;
      setupChannel(ch);
    }
  }

  pc.onicecandidate=e=>{
    if(e.candidate) return;
    document.getElementById("signal").value=JSON.stringify(pc.localDescription);
  }

  pc.ontrack=e=>{
    const audio=document.createElement("audio");
    audio.srcObject=e.streams[0];
    audio.autoplay=true;
    document.body.appendChild(audio);
  }

  pcList[id]=pc;
  return pc;
}

function setupChannel(ch){
  ch.onmessage=e=>{
    const data=JSON.parse(e.data);
    if(data.type==="text") log(`${data.name}: ${data.text}`,"other");
    else if(data.type==="file"){
      const blob=new Blob([data.blob],{type:data.blobType});
      const url=URL.createObjectURL(blob);
      log(`${data.name}ãŒãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡: ${data.filename} (ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜)`);
      const a=document.createElement("a");
      a.href=url; a.download=data.filename; a.textContent="ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
      messages.appendChild(a);
    }
  };
}

async function makeOffer(){
  const id="peer_"+Math.random().toString(36).substr(2,5);
  const pc=createPeer(id,true);
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  document.getElementById("signal").value=JSON.stringify(offer);
  log("ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç›¸æ‰‹ã«é€ã£ã¦ãã ã•ã„");
}

async function connectToPeer(){
  const data=document.getElementById("signal").value.trim();
  if(!data) return;
  const desc=JSON.parse(data);
  const id="peer_"+Math.random().toString(36).substr(2,5);
  const pc=createPeer(id,desc.type==="offer"?false:true);
  await pc.setRemoteDescription(desc);
  if(desc.type==="offer"){
    const answer=await pc.createAnswer();
    await pc.setLocalDescription(answer);
    document.getElementById("signal").value=JSON.stringify(answer);
  }
}

document.getElementById("copy").onclick=makeOffer;
document.getElementById("connect").onclick=connectToPeer;

document.getElementById("send").onclick=()=>{
  const text=document.getElementById("text").value.trim();
  localName=document.getElementById("name").value.trim()||"åŒ¿å";
  if(!text) return;
  log(`${localName}: ${text}`,"you");
  for(const id in channelList) channelList[id].send(JSON.stringify({type:"text",name:localName,text}));
  document.getElementById("text").value="";
};

// éŸ³å£°ON/OFF
let voiceEnabled=false;
document.getElementById("voice").onclick=async()=>{
  if(!voiceEnabled){
    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
    voiceEnabled=true;
    document.getElementById("voice").textContent="éŸ³å£°OFF";
    log("ğŸ¤ éŸ³å£°ON");
  }else{
    localStream.getTracks().forEach(track=>track.stop());
    localStream=null;
    voiceEnabled=false;
    document.getElementById("voice").textContent="éŸ³å£°ON";
    log("ğŸ¤ éŸ³å£°OFF");
  }
};

// ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡
document.getElementById("fileInput").onchange=e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const data={type:"file",name:localName,filename:file.name,blob:new Uint8Array(reader.result),blobType:file.type};
    for(const id in channelList) channelList[id].send(JSON.stringify(data));
    log(`${localName}ãŒãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡: ${file.name}`,"you");
  };
  reader.readAsArrayBuffer(file);
};
</script>
</body>
</html>
