<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simple Multi Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family: Arial, sans-serif; background:#f7f7f7; padding:10px;}
    #app{max-width:800px;margin:0 auto;background:white;padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    #messages{height:400px;overflow:auto;border:1px solid #eee;padding:8px;margin-bottom:10px;background:#fff;}
    .msg{margin:6px 0}
    .sys{color:#666;font-style:italic}
    .me{color:green}
    .peer{color:blue}
    #controls input, #controls button {padding:8px;margin:4px 0;width:100%;}
    .row{display:flex;gap:8px}
    .row input{flex:1}
  </style>
</head>
<body>
<div id="app">
  <h2>Simple Multi Chat</h2>

  <div id="lobby">
    <input id="roomInput" placeholder="ルーム名 (例: lobby)" />
    <input id="nameInput" placeholder="あなたの名前" />
    <button id="joinBtn">参加 / ルーム作成</button>
  </div>

  <div id="chatArea" style="display:none">
    <div id="messages"></div>

    <div id="controls">
      <div class="row">
        <input id="msgInput" placeholder="メッセージを入力" />
        <button id="sendBtn">送信</button>
      </div>
      <button id="leaveBtn">退出</button>
    </div>
  </div>
</div>

<script>
(function(){
  let ws;
  const messagesEl = document.getElementById('messages');
  const roomInput = document.getElementById('roomInput');
  const nameInput = document.getElementById('nameInput');
  const joinBtn = document.getElementById('joinBtn');
  const chatArea = document.getElementById('chatArea');
  const lobby = document.getElementById('lobby');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const leaveBtn = document.getElementById('leaveBtn');

  function append(text, cls='msg') {
    const d = document.createElement('div');
    d.className = cls;
    d.textContent = text;
    messagesEl.appendChild(d);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  joinBtn.onclick = () => {
    const room = roomInput.value.trim() || 'default';
    const name = nameInput.value.trim() || '匿名';
    // connect to WS server (adjust host/port as needed)
    const base = location.hostname === 'localhost' ? `ws://${location.hostname}:3000/ws` : `wss://${location.hostname}/ws`;
    // If server hosted elsewhere, change URL like 'wss://your-domain/ws'
    const wsUrl = (window.CHAT_WS_URL && window.CHAT_WS_URL.length) ? window.CHAT_WS_URL : base;
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      ws.send(JSON.stringify({ type:'join', room, name }));
      lobby.style.display = 'none';
      chatArea.style.display = 'block';
      append(`あなたは ${name} として ${room} に参加しました`, 'sys');
    };
    ws.onmessage = (ev) => {
      let m;
      try { m = JSON.parse(ev.data); } catch(e){ return; }
      if (m.type === 'system') append(m.text, 'sys');
      else if (m.type === 'chat') {
        const who = (m.name === name) ? 'me' : 'peer';
        append(`${m.name}: ${m.text}`, who);
      }
    };
    ws.onclose = () => {
      append('接続が切れました', 'sys');
      lobby.style.display = '';
      chatArea.style.display = 'none';
    };
    ws.onerror = (e) => { console.error(e); append('通信エラー', 'sys'); };
  };

  sendBtn.onclick = () => {
    const text = msgInput.value.trim();
    if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
    const room = roomInput.value.trim() || 'default';
    const name = nameInput.value.trim() || '匿名';
    ws.send(JSON.stringify({ type:'chat', room, name, text }));
    msgInput.value = '';
  };
  msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendBtn.click(); });

  leaveBtn.onclick = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type:'leave' }));
      ws.close();
    }
  };

})();
</script>
</body>
</html>
