<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>min2 Chat</title>
<style>
body{margin:0;font-family:sans-serif;background:#0f1221;color:#e8ebff;}
header{padding:10px;background:#171a2b;display:flex;justify-content:space-between;align-items:center;}
main{padding:10px;overflow-y:auto;height:70vh;}
footer{padding:10px;background:#121527;display:flex;gap:10px;}
input,textarea{flex:1;padding:6px;border-radius:6px;border:none;background:#1c2040;color:#e8ebff;}
button{padding:6px 12px;border:none;border-radius:6px;background:#6c8cff;color:#fff;cursor:pointer;}
.msg{margin:6px 0;padding:8px;border-radius:10px;background:#1c2040;}
.msg.self{background:#2a356b;text-align:right;}
</style>
</head>
<body>
<header>
  <div>min2 Chat</div>
  <div id="userCount">オンライン: -</div>
</header>
<main id="messages"></main>
<footer>
  <input type="text" id="username" placeholder="名前" maxlength="24" />
  <textarea id="messageInput" placeholder="メッセージ" rows="1"></textarea>
  <button id="sendBtn">送信</button>
</footer>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  const SERVER_URL = 'https://あなたのサーバーのURL'; // ←ここを自分のSocket.IOサーバーURLに変更
  const socket = io(SERVER_URL);

  const el = {
    messages: document.getElementById('messages'),
    username: document.getElementById('username'),
    messageInput: document.getElementById('messageInput'),
    sendBtn: document.getElementById('sendBtn'),
    userCount: document.getElementById('userCount')
  };

  let myName = localStorage.getItem('chat_username') || '';

  el.username.value = myName;

  function nowTimeString(){
    const d = new Date();
    return d.toLocaleString();
  }

  function renderMessage(msg){
    const div = document.createElement('div');
    div.className = 'msg' + (msg.seed===localStorage.getItem('chat_seed')?' self':'');
    div.textContent = `[${msg.time}] ${msg.username}: ${msg.message}`;
    el.messages.appendChild(div);
    el.messages.scrollTop = el.messages.scrollHeight;
  }

  socket.on('connect', ()=>{ console.log('接続完了'); });
  socket.on('disconnect', ()=>{ console.log('切断'); });

  socket.on('initMessages', (msgs)=>{
    el.messages.innerHTML='';
    msgs.forEach(renderMessage);
  });

  socket.on('newMessage', renderMessage);

  socket.on('clearMessages', ()=>{
    el.messages.innerHTML='';
    alert('管理者により全メッセージ削除されました');
  });

  socket.on('userCount', (count)=>{
    el.userCount.textContent = `オンライン: ${count}`;
  });

  el.sendBtn.addEventListener('click', sendMessage);
  el.messageInput.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  function sendMessage(){
    const txt = el.messageInput.value.trim();
    if(!txt) return;
    let seed = localStorage.getItem('chat_seed');
    if(!seed){ seed = crypto.randomUUID(); localStorage.setItem('chat_seed', seed); }
    myName = el.username.value.trim() || '匿名';
    localStorage.setItem('chat_username', myName);
    const msg = { username: myName, message: txt, seed, time: nowTimeString() };
    socket.emit('sendMessage', msg);
    el.messageInput.value='';
  }

})();
</script>
</body>
</html>
