<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>min2 Chat - ルーム機能付き</title>
<style>
body{margin:0;font-family:sans-serif;background:#0f1221;color:#e8ebff;}
header{padding:10px;background:#171a2b;display:flex;justify-content:space-between;align-items:center;}
main{padding:10px;overflow-y:auto;height:60vh;}
footer{padding:10px;background:#121527;display:flex;gap:5px;align-items:center;}
input,textarea,select{flex:1;padding:6px;border-radius:6px;border:none;background:#1c2040;color:#e8ebff;}
button{padding:6px 12px;border:none;border-radius:6px;background:#6c8cff;color:#fff;cursor:pointer;}
.msg{margin:6px 0;padding:8px;border-radius:10px;background:#1c2040;}
.msg.self{background:#2a356b;text-align:right;}
</style>
</head>
<body>
<header>
  <div>min2 Chat</div>
  <div id="userCount">オンライン: -</div>
</header>
<main id="messages"></main>
<footer>
  <select id="roomSelect"></select>
  <input type="text" id="username" placeholder="名前" maxlength="24" />
  <textarea id="messageInput" placeholder="メッセージ" rows="1"></textarea>
  <button id="sendBtn">送信</button>
  <button id="createRoomBtn">ルーム作成</button>
</footer>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  const SERVER_URL = 'https://あなたのサーバーのURL'; // ←自分のSocket.IOサーバーに変更
  const socket = io(SERVER_URL);

  const el = {
    messages: document.getElementById('messages'),
    username: document.getElementById('username'),
    messageInput: document.getElementById('messageInput'),
    sendBtn: document.getElementById('sendBtn'),
    userCount: document.getElementById('userCount'),
    roomSelect: document.getElementById('roomSelect'),
    createRoomBtn: document.getElementById('createRoomBtn')
  };

  let myName = localStorage.getItem('chat_username') || '';
  let mySeed = localStorage.getItem('chat_seed') || crypto.randomUUID();
  localStorage.setItem('chat_seed', mySeed);

  el.username.value = myName;

  let currentRoom = 'general';

  function nowTimeString(){
    const d = new Date();
    return d.toLocaleString();
  }

  function renderMessage(msg){
    const div = document.createElement('div');
    div.className = 'msg' + (msg.seed===mySeed?' self':'');
    div.textContent = `[${msg.time}] ${msg.username}: ${msg.message}`;
    el.messages.appendChild(div);
    el.messages.scrollTop = el.messages.scrollHeight;
  }

  function joinRoom(room){
    currentRoom = room;
    el.messages.innerHTML='';
    socket.emit('joinRoom', room);
  }

  socket.on('connect', ()=>{ console.log('接続完了'); });
  socket.on('disconnect', ()=>{ console.log('切断'); });

  socket.on('roomList', (rooms)=>{
    el.roomSelect.innerHTML='';
    rooms.forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      el.roomSelect.appendChild(opt);
    });
    el.roomSelect.value = currentRoom;
  });

  socket.on('initMessages', (msgs)=>{
    el.messages.innerHTML='';
    msgs.forEach(renderMessage);
  });

  socket.on('newMessage', renderMessage);

  socket.on('userCount', (count)=>{
    el.userCount.textContent = `オンライン: ${count}`;
  });

  el.sendBtn.addEventListener('click', sendMessage);
  el.messageInput.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  el.roomSelect.addEventListener('change', e=>{
    joinRoom(e.target.value);
  });

  el.createRoomBtn.addEventListener('click', ()=>{
    const room = prompt('新しいルーム名を入力してください').trim();
    if(room) socket.emit('createRoom', room);
  });

  function sendMessage(){
    const txt = el.messageInput.value.trim();
    if(!txt) return;
    myName = el.username.value.trim() || '匿名';
    localStorage.setItem('chat_username', myName);
    const msg = { username: myName, message: txt, seed: mySeed, time: nowTimeString(), room: currentRoom };
    socket.emit('sendMessage', msg);
    el.messageInput.value='';
  }

})();
</script>
</body>
</html>
